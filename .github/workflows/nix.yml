name: nix

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/flakehub-cache-action@main
      - run: nix build .#nixosConfigurations.zeus-ci.config.system.build.toplevel -o result-toplevel
      - run: nix build .#zeus-installer-iso -o result-iso
      - uses: actions/upload-artifact@v4
        with:
          name: zeus-installer-iso
          path: result-iso/iso/*.iso
      - name: Debug HF_REPO (masked)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          HF_REPO: ${{ secrets.HF_REPO }}
        run: |
          if [ -z "$HF_REPO" ]; then
            echo "HF_REPO is empty or not set"
            exit 1
          fi
          echo "HF_REPO=$HF_REPO"
          echo "HF_REPO length=${#HF_REPO}"
      - name: Upload ISO to Hugging Face Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ secrets.HF_REPO }}
        run: |
          python -m pip install --upgrade huggingface_hub
          ISO=$(ls result-iso/iso/*.iso | head -n1)
          hf upload "$HF_REPO" "$ISO" --repo-type dataset --token "$HF_TOKEN"
