name: nix

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Free disk space
        run: |
          set -euo pipefail
          echo "Disk usage before:"
          df -h

          # Remove large preinstalled toolchains we don't need for Nix builds.
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/.ghcup /usr/local/lib/android
          sudo rm -rf /usr/local/share/powershell /usr/local/share/chromium || true

          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

          sudo docker system prune -af || true

          echo "Disk usage after:"
          df -h
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/flakehub-cache-action@main
      - run: nix build .#nixosConfigurations.zeus-ci.config.system.build.toplevel -o result-toplevel
        env:
          NIX_CONFIG: |
            extra-substituters = https://nix-community.cachix.org
            extra-trusted-public-keys = nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
